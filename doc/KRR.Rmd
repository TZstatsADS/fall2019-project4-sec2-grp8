---
title: "KRR"
output: html_document
---

```{r packages}
install.packages("remotes")
remotes::install_github("TimothyKBook/krr")

library(krr)
library(dplyr)
library(caret)
library(ModelMetrics)
```

```{r MAIN FUNCTION}
cv.krr <- function(data, kfold, lam){
  
  set.seed(123)
  
  data.x <- as.matrix(data[,-1])
  data.y <- data[,1]
  
  n <- nrow(data.x)
  cv.id <- createFolds(1:n, k = kfold)
  
  cv.tuning <- c()
  
  for (j in cv.id){
    
    #Split Data in train and validation sets
    x.train.cv <- data.x[-j,]
    y.train.cv <- data.y[-j]
    
    x.validation.cv <- data.x[j,]
    y.validation.cv <- data.y[j]
    
    #Run Model
    mod.cv <- krr(x = x.train.cv,  y.train.cv, lambda = lam)
    
    #Estimate predictin of validation test
    pred.cv <- predict(mod.cv, x.validation.cv)
    
    #Calculate RMSE
    rmse.cv <- sqrt(mean((y.validation.cv - pred.cv)^2))
    cv.tuning <- cbind(cv.tuning, rmse.cv)
    cv.mean <- mean(cv.tuning)
    }
  
  return(cv.mean)
}
```


```{r TUNE LAMBDA SMALL}
load("../output/data_split.RData")
load("../output/data_split_small.RData")

cv.krr(data_split_small[[1]], 5, 1)

lambdas_small <- c(0.1, 0.2, 0.3, 0.4)

mse.small <- c()

for (x in lambdas_small){
  m.small <- lapply(data_split_small, cv.krr, 5, 1)
  mse.small <- cbind(mse.small, sum(unlist(m.small)))
  mse.small <- rbind(mse.small, lambdas_small)
}
```

```{r TUNE LAMBDA BIG}
load("../output/data_split_big.RData")

lambdas_big <- c(0.4, 0.5, 0.6, 0.7, 0.8)

mse.big <- c()

for (x in lambdas_big){
  m.big <- lapply(data_split_big, cv.krr, 5, x)
  mse.big <- cbind(mse.big, sum(unlist(m.big)))
  mse.big <- rbind(mse.big, lambdas_big)
}
```

```{r RUN REGRESSION}
bestlam <- 0.5

predicted.rating <- c()

predict.krr <- function(data.train, data.test){
  
  data.x <- as.matrix(data[,-1])
  data.y <- data[,1]
  
  data.x.test <- as.matrix
  
  mod <- krr(x = data.x,  y = data.y, lambda = bestlam)
  pred <- predict(mod, x.test)
  
  predicted.rating <- c(predicted.rating, pred)
}
```

```{r WEIGHTED AVERAGE}
weights <- c(0.1, 0.9)

rmse <- c()
for (w in weights){
  rating.weighted <- rating.sda(1-w) + rating.krr(w)
  r <- sqrt(mean((y.true - rating.weighted)^2))
  rmse <- rbind(rmse, r)
}

```



